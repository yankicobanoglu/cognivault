<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <title>Dual N-Backer</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3665/3665923.png">
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            background-color: #020617;
            color: white;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            touch-action: none;
        }
        #root {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #initial-loader {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #020617;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .loader-ring {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(99, 102, 241, 0.1);
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Custom Animations */
        @keyframes pulse-glow {
          0%, 100% { transform: scale(1); opacity: 0.1; }
          50% { transform: scale(1.2); opacity: 0.3; }
        }
        .neural-mesh {
          mask-image: radial-gradient(circle at center, black, transparent 80%);
        }
        button:focus { outline: none; }
        /* Scrollbar for legal modal */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    </style>

    <!-- Import Maps -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
        "@vercel/analytics/react": "https://esm.sh/@vercel/analytics/react?deps=react@18.2.0"
      }
    }
    </script>
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="initial-loader">
        <div class="loader-ring"></div>
        <div style="font-size: 10px; letter-spacing: 3px; color: #6366f1; font-weight: 900; text-transform: uppercase;">System Loading</div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Analytics } from '@vercel/analytics/react';
        import { Volume2, Square, Play, RotateCcw, Zap, Info, TrendingUp, Trophy, Brain, Palette, Gauge, Target, HelpCircle, XCircle, ChevronRight, CheckCircle2, ArrowLeft, BarChart3, Settings, EyeOff, Calendar, Globe, Flame, Star, ZapOff, Trash2, Swords, Share2 } from 'lucide-react';

        // --- CONSTANTS & DATA ---
        const LETTERS_TR = ['A', 'E', '襤', 'O', 'U', 'C', 'T', 'S', 'Y'];
        const LETTERS_EN = ['A', 'E', 'I', 'O', 'U', 'C', 'T', 'S', 'Y'];
        const LETTERS = LETTERS_EN;

        const COLORS = [
          '#ef4444', '#3b82f6', '#22c55e', '#eab308', 
          '#a855f7', '#f97316', '#06b6d4', '#ec4899', '#f8fafc'
        ];

        const SPEED_SETTINGS = {
          slow: 3500,
          normal: 2500,
          fast: 1500,
        };

        const STIMULUS_DURATION = 500;

        const getSequenceLength = (level, isPractice) => {
          if (isPractice) return 1000;
          if (level === 1) return 21;
          if (level === 2) return 25;
          return 30;
        };

        const PHONETIC_MAP_TR = {
          'A': 'aa', 'E': 'eee', '襤': 'iii', 'O': 'oo', 'U': 'uu',
          'C': 'cee', 'T': 'tee', 'S': 'seee', 'Y': 'yee'
        };

        const RANKS = [
          { minXp: 0, name: '繹mez' },
          { minXp: 500, name: 'Odak Stajyeri' },
          { minXp: 1500, name: 'Zihin Mimar覺' },
          { minXp: 4000, name: 'Haf覺za Ustas覺' },
          { minXp: 10000, name: 'N繹ro Grandmaster' }
        ];

        const RANKS_EN = [
          { minXp: 0, name: 'Novice' },
          { minXp: 500, name: 'Focus Intern' },
          { minXp: 1500, name: 'Mind Architect' },
          { minXp: 4000, name: 'Memory Master' },
          { minXp: 10000, name: 'Neuro Grandmaster' }
        ];

        const XP_MULTIPLIERS = {
          position: 1, dual: 1.5, triple: 2.2,
          fast: 1.3, normal: 1, slow: 0.7
        };

        const TRANSLATIONS = {
          tr: {
            title: "Can覺m Anam", subtitle: "Haf覺za Oyunu", streak: "G羹n", score: "Puan",
            gameParamsTitle: "OYUN PARAMETRELER襤",
            gameMode: "OYUN MODU", 
            gameModeDesc: "Hem konumu, hem de harf sesini (ikili) ya da konum, ses ve rengi takip edin (羹癟l羹).",
            difficulty: "ZORLUK DERECES襤 (N)", 
            difficultyDesc: "Mevcut uyaran覺n, N ad覺m 繹nceki uyaranla eleip elemediini bulun.",
            dailyRace: "G羹nl羹k Yar覺", 
            dailyRaceDesc: "Her g羹n herkes i癟in ayn覺 olan sabit diziyle oynay覺n ve skorunuzu kar覺lat覺r覺n.",
            speed: "OYUN R襤TM襤", 
            trainingMode: "E襤T襤M MODU",
            practice: "Al覺t覺rma", 
            practiceDesc: "S羹re veya dizi s覺n覺r覺 olmadan, hata yapma korkusu yaamadan pratik yap覺n.",
            marathon: "Maraton", 
            marathonDesc: "Tek bir hata yapana kadar oyun devam eder. Ne kadar dayanabilirsiniz?",
            zenMode: "Zen Modu", 
            zenModeDesc: "Skor, aray羹z ve dikkat da覺t覺c覺lar gizlenir. Sadece ak覺a odaklan覺n.",
            soundCheck: "Ses Kontrol", startGame: "Oyunu Balat",
            challenge: "Meydan Oku", challengeDesc: "Arkada覺na 繹zel bir kodla meydan oku.",
            position: "Konum", dual: "襤kili", triple: "癟l羹", sound: "Ses", color: "Renk",
            progress: "襤lerleme", endGame: "Oyunu Bitir", perfectSession: "M羹kemmel Seans!",
            sessionComplete: "Seans Tamamland覺", correct: "DORU", mistakes: "HATA",
            menu: "Men羹ye D繹n", shareScore: "Yeni Skor!",
            shareMsg: "Can覺m Anam oyununda N-{level} seviyesinde %{score} skor yapt覺m!",
            challengeReady: "Meydan Okuma Haz覺r", shareLink: "Balant覺y覺 Payla",
            cancel: "Vazge癟 ve D繹n", neuralMetrics: "N繹ral Metrikler",
            reactionTime: "Tepki S羹resi", bestN: "En 襤yi Zorluk", attentionMap: "Dikkat Eksiklii Haritas覺",
            resetData: "TM VER襤LER襤 SIFIRLA", resetConfirm: "T羹m verileriniz silinecek. Emin misiniz?",
            shareTitle: "Can覺m Anam - Zihin Egzersizi", sharePrompt: " Haf覺zan覺 ve odaklanman覺 test et! \"Can覺m Anam\" oyununda ka癟覺nc覺 seviyeye 癟覺kabilirsin? Hemen oyna:",
            slow: "Yava", normal: "Normal", fast: "H覺zl覺",
            incomingChallenge: "Bir Meydan Okuman Var!", friendScore: "Arkada覺n bu ayarlarda <b>%{score}</b> skor yapt覺.",
            canYouBeat: "Onu ge癟ebilir misin?", level: "Seviye", mode: "Mod",
            acceptChallenge: "Meydan Okumay覺 Kabul Et", decline: "Reddet ve Normal Oyna",
            howToPlay: "Nas覺l Oynan覺r?",
            intro1: "Bu oyun, 癟al覺ma belleini ve odaklanmay覺 g羹癟lendirmeyi ama癟layan, \"Dual N-Back\" temelli bir zihin egzersizidir.",
            intro2: "Ekranda s覺rayla beliren karelerin konumunu ve e zamanl覺 olarak okunan harfleri akl覺n覺zda tutman覺z gerekir.",
            intro3: "Eer u anki konum veya harf, belirlenen seviye say覺s覺 kadar (繹rnein 1 ad覺m) 繹ncesindekiyle ayn覺ysa, ilgili butona basarak elemeyi yakalamal覺s覺n覺z.",
            gotIt: "Anlad覺m, Bala",
            tutorialWelcome: "Nas覺l Oynan覺r", tutorialWelcomeText: "Ho geldiniz. Bu protokol 癟al覺ma bellei kapasitenizi h覺zla art覺r覺r. Kalibrasyona balayal覺m.",
            tutorialReady: "G繹reve Haz覺r", tutorialReadyText: "Haz覺rl覺k tamamland覺. Kontroller: A (Konum), L (Ses), S (Renk). Baar覺lar.",
            tutorialStep1: "N=1 i癟in karemizin mevcut yerini akl覺n覺zda tutun. 襤lk konum iaretlendi.",
            tutorialStep2: "Yeni bir konum iaretlendi. imdi bir 繹nceki kareyle kar覺lat覺rma yapaca覺z.",
            tutorialStep3Match: "N=1 modunda, mevcut kare az 繹nceki kareyle ayn覺 yerdeyse KONUM butonuna bas覺n!",
            tutorialBtn: "KONUM BUTONU", continue: "Devam Et", start: "Balat",
            standard: "Standart", standardDesc: "20-30 ad覺ml覺k klasik seans.", playAgain: "Tekrar Oyna",
            terms: "Kullan覺m Koullar覺", privacy: "Gizlilik Politikas覺", rights: "T羹m haklar覺 sakl覺d覺r.", close: "Kapat",
            privacyContent: "Bu uygulama kiisel verilerinizi toplamaz veya harici sunucularda saklamaz. T羹m oyun ilerlemesi, istatistikler ve ayarlar taray覺c覺n覺z覺n yerel depolama alan覺nda (LocalStorage) tutulur. Verilerinizi 'Ayarlar > Verileri S覺f覺rla' se癟enei ile dilediiniz zaman silebilirsiniz.",
            termsContent: "Bu uygulama 'olduu gibi' sunulmaktad覺r. Zihinsel egzersiz ama癟l覺d覺r ve t覺bbi bir tedavi yerine ge癟mez. Gelitirici, uygulaman覺n kullan覺m覺ndan doabilecek sonu癟lardan sorumlu deildir.",
            vibedWith: "Vibed with Gemini",
            analytics: "Analizler", analyticsDesc: "Performans ve geliim grafikleri.", noData: "Hen羹z veri yok.",
            brainTraining: "Zihin Eitimi"
          },
          en: {
            title: "Dual N-Backer", subtitle: "Memory Game", streak: "Day Streak", score: "XP",
            gameParamsTitle: "GAME PARAMETERS",
            gameMode: "GAME MODE", 
            gameModeDesc: "Track position and letter sound (dual) or position, sound, and color (triple).",
            difficulty: "DIFFICULTY LEVEL (N)", 
            difficultyDesc: "Identify if the current stimulus matches the one N steps earlier.",
            dailyRace: "Daily Race", 
            dailyRaceDesc: "Play with a fixed sequence identical for everyone every day and compare your score.",
            speed: "SPEED", 
            trainingMode: "TRAINING MODE",
            practice: "Practice", 
            practiceDesc: "Practice without time or sequence limits, without the fear of making mistakes.",
            marathon: "Marathon", 
            marathonDesc: "The game continues until you make a single mistake. How long can you last?",
            zenMode: "Zen Mode", 
            zenModeDesc: "Score, interface, and distractions are hidden. Focus only on the flow.",
            soundCheck: "Sound Check", startGame: "Start the Game",
            challenge: "Challenge", challengeDesc: "Challenge a friend with a custom seed.",
            position: "Position", dual: "Dual", triple: "Triple", sound: "Audio", color: "Color",
            progress: "Progress", endGame: "End Game", perfectSession: "Perfect Session!",
            sessionComplete: "Session Complete", correct: "CORRECT", mistakes: "MISTAKES",
            menu: "Back to Menu", shareScore: "New Score!",
            shareMsg: "I scored %{score} in Dual N-Backer at N-{level}!",
            challengeReady: "Challenge Ready", shareLink: "Share Link",
            cancel: "Cancel & Return", neuralMetrics: "Neural Metrics",
            reactionTime: "Reaction Time", bestN: "Best N-Back", attentionMap: "Attention Heatmap",
            resetData: "RESET ALL DATA", resetConfirm: "All progress, scores, and history will be permanently deleted. Are you sure?",
            shareTitle: "Dual N-Backer - Brain Training", sharePrompt: " Test your memory and focus! How high can you go in \"Dual N-Backer\"? Play now:",
            slow: "Slow", normal: "Normal", fast: "Fast",
            incomingChallenge: "Incoming Challenge!", friendScore: "Your friend scored <b>%{score}</b> with these settings.",
            canYouBeat: "Can you beat them?", level: "Level", mode: "Mode",
            acceptChallenge: "Accept Challenge", decline: "Decline & Play Normal",
            howToPlay: "How to Play?",
            intro1: "This game is a brain exercise based on \"Dual N-Back\" designed to improve working memory and focus.",
            intro2: "You must remember the position of the squares and the letters spoken simultaneously.",
            intro3: "If the current position or letter is the same as the one N steps back (e.g., 1 step), press the corresponding button to catch the match.",
            gotIt: "Got it, Start",
            tutorialWelcome: "How to Play", tutorialWelcomeText: "Welcome. This protocol rapidly increases working memory capacity. Let's calibrate.",
            tutorialReady: "Ready to Start", tutorialReadyText: "Calibration complete. Controls: A (Position), L (Audio), S (Color). Good luck.",
            tutorialStep1: "For N=1, remember the position of the square. First position marked.",
            tutorialStep2: "New position marked. Now we will compare with the previous square.",
            tutorialStep3Match: "In N=1 mode, if the current square is in the same place as the previous one, press POSITION!",
            tutorialBtn: "POSITION BUTTON", continue: "Continue", start: "Start",
            standard: "Standard", standardDesc: "Classic 20-30 step session.", playAgain: "Play Again",
            terms: "Terms of Service", privacy: "Privacy Policy", rights: "All rights reserved.", close: "Close",
            privacyContent: "This application does not collect or store personal data on external servers. All game progress, statistics, and settings are stored locally in your browser's storage (LocalStorage). You can delete your data at any time via 'Settings > Reset Data'.",
            termsContent: "This application is provided 'as is'. It is intended for mental exercise purposes and does not substitute medical treatment. The developer is not liable for any outcomes resulting from the use of this application.",
            vibedWith: "Vibed with Gemini",
            analytics: "Analytics", analyticsDesc: "Performance and growth charts.", noData: "No data yet.",
            brainTraining: "Brain Training"
          }
        };

        // --- UTILS ---
        
        // Speech Utils
        const resumeAudio = () => {
          if (window.speechSynthesis.paused) {
            window.speechSynthesis.resume();
          }
        };

        const speakLetter = (letter, lang, voice) => {
          const synth = window.speechSynthesis;
          resumeAudio();
          synth.cancel();

          setTimeout(() => {
            let rate = 0.8; 
            let text = letter.toLowerCase();
            let langCode = lang === 'tr' ? 'tr-TR' : 'en-US';

            if (lang === 'tr') {
               if (['A', 'O', 'U'].includes(letter)) rate = 0.85;
               else if (['E', '襤'].includes(letter)) rate = 0.8;
               text = PHONETIC_MAP_TR[letter] || letter.toLowerCase();
            } else {
               rate = 0.9;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            if (voice) utterance.voice = voice;
            utterance.rate = rate;
            utterance.volume = 1.0;
            utterance.pitch = 1.0;
            utterance.onerror = (e) => {
              console.warn("Speech error:", e);
              synth.cancel();
              resumeAudio();
            };
            synth.speak(utterance);
          }, 50);
        };

        const loadVoices = (lang, callback) => {
          const synth = window.speechSynthesis;
          let attempts = 0;
          
          const findVoice = () => {
            const voices = synth.getVoices();
            if (voices.length > 0) {
              let targetVoice;
              if (lang === 'tr') {
                targetVoice = voices.find(v => v.lang === 'tr-TR' || v.lang === 'tr_TR') 
                              || voices.find(v => v.lang.startsWith('tr'));
              } else {
                targetVoice = voices.find(v => v.lang === 'en-US' || v.lang === 'en_US' || v.lang === 'en-GB')
                              || voices.find(v => v.lang.startsWith('en'));
              }
              callback(targetVoice || null);
              return true;
            }
            return false;
          };
          
          if (findVoice()) return;

          const intervalId = setInterval(() => {
            attempts++;
            if (findVoice() || attempts > 20) {
              clearInterval(intervalId);
            }
          }, 100);

          synth.onvoiceschanged = () => {
            findVoice();
            clearInterval(intervalId);
          };
        };

        // Sequence Utils
        const mulberry32 = (a) => {
          return () => {
            let t = a += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
          }
        };

        const findMatches = (seq, n) => {
          const posMatches = [];
          const sndMatches = [];
          const colMatches = [];
          
          for (let i = n; i < seq.length; i++) {
            if (seq[i].position === seq[i - n].position) posMatches.push(i);
            if (seq[i].sound === seq[i - n].sound) sndMatches.push(i);
            if (seq[i].color === seq[i - n].color) colMatches.push(i);
          }
          
          return { posMatches, sndMatches, colMatches };
        };

        const preventTriplets = (seq, n, mode, random, letters) => {
          let matches = findMatches(seq, n);
          const modalities = ['position'];
          if (mode === 'dual' || mode === 'triple') modalities.push('sound');
          if (mode === 'triple') modalities.push('color');

          modalities.forEach(mod => {
            const matchKey = mod === 'position' ? 'posMatches' : mod === 'sound' ? 'sndMatches' : 'colMatches';
            let fixed = false;
            let iterations = 0;
            while (!fixed && iterations < 5) {
              fixed = true;
              matches = findMatches(seq, n);
              const currentMatches = matches[matchKey];

              for (let i = 0; i < currentMatches.length - 2; i++) {
                const idx1 = currentMatches[i];
                const idx2 = currentMatches[i + 1];
                const idx3 = currentMatches[i + 2];

                if (idx2 === idx1 + 1 && idx3 === idx2 + 1) {
                  fixed = false;
                  if (mod === 'position') {
                    let newVal;
                    do { newVal = Math.floor(random() * 9); } 
                    while (newVal === seq[idx2 - n].position || newVal === seq[idx2].position);
                    seq[idx2].position = newVal;
                  } else if (mod === 'sound') {
                    let newVal;
                    do { newVal = letters[Math.floor(random() * letters.length)]; }
                    while (newVal === seq[idx2 - n].sound || newVal === seq[idx2].sound);
                    seq[idx2].sound = newVal;
                  } else if (mod === 'color') {
                    let newVal;
                    do { newVal = COLORS[Math.floor(random() * COLORS.length)]; }
                    while (newVal === seq[idx2 - n].color || newVal === seq[idx2].color);
                    seq[idx2].color = newVal;
                  }
                }
              }
              iterations++;
            }
          });

          return seq;
        };

        const generateSequence = (level, mode, length, letters, seed) => {
          const random = seed !== undefined ? mulberry32(seed) : Math.random;
          const minMatches = Math.floor(random() * 4) + 5; 
          
          let seq = [];
          let lastPosition = -1;
          
          for (let i = 0; i < length; i++) {
            let newPosition;
            do {
              newPosition = Math.floor(random() * 9);
            } while (newPosition === lastPosition && random() > 0.3);
            
            lastPosition = newPosition;
            seq.push({
              position: newPosition,
              sound: letters[Math.floor(random() * letters.length)],
              color: COLORS[Math.floor(random() * COLORS.length)]
            });
          }

          seq = preventTriplets(seq, level, mode, random, letters);
          
          const injectMatches = (modality) => {
            let current = findMatches(seq, level);
            let attempts = 0;
            const matchKey = modality === 'position' ? 'posMatches' : modality === 'sound' ? 'sndMatches' : 'colMatches';

            while (attempts < 100 && current[matchKey].length < minMatches) {
              const available = [];
              for (let i = level; i < length; i++) {
                if (!current[matchKey].includes(i)) {
                  const isPrevMatch = current[matchKey].includes(i - 1);
                  const isPrevPrevMatch = current[matchKey].includes(i - 2);
                  const isNextMatch = current[matchKey].includes(i + 1);
                  const isNextNextMatch = current[matchKey].includes(i + 2);

                  const formsTriplet = (isPrevMatch && isPrevPrevMatch) || 
                                       (isPrevMatch && isNextMatch) || 
                                       (isNextMatch && isNextNextMatch);

                  if (!formsTriplet) {
                    available.push(i);
                  }
                }
              }

              if (available.length === 0) break;
              
              const randomIdx = available[Math.floor(random() * available.length)];
              if (modality === 'position') seq[randomIdx].position = seq[randomIdx - level].position;
              else if (modality === 'sound') seq[randomIdx].sound = seq[randomIdx - level].sound;
              else if (modality === 'color') seq[randomIdx].color = seq[randomIdx - level].color;
              
              current = findMatches(seq, level);
              attempts++;
            }
          };

          injectMatches('position');
          if (mode === 'dual' || mode === 'triple') injectMatches('sound');
          if (mode === 'triple') injectMatches('color');
          
          seq = preventTriplets(seq, level, mode, random, letters);
          
          return seq;
        };

        // --- COMPONENTS ---

        const FlagTR = ({ className = "w-full h-full" }) => (
          <svg viewBox="140 0 800 800" className={className} xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice">
            <rect width="1200" height="800" fill="#E30A17"/>
            <circle cx="444" cy="400" r="200" fill="#ffffff"/>
            <circle cx="480" cy="400" r="160" fill="#E30A17"/>
            <path fill="#ffffff" transform="translate(628,400) rotate(-18)" d="M0,-60 L13.8,-18.8 L57.1,-18.8 L22,-5.9 L35.6,35.6 L0,10 L-35.6,35.6 L-22,-5.9 L-57.1,-18.8 L-13.8,-18.8 Z"/>
          </svg>
        );

        const FlagUK = ({ className = "w-full h-full" }) => {
          const id = React.useId();
          return (
            <svg viewBox="15 0 30 30" className={className} xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice">
              <defs>
                <clipPath id={`${id}-s`}>
                    <path d="M0,0 v30 h60 v-30 z"/>
                </clipPath>
                <clipPath id={`${id}-t`}>
                    <path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/>
                </clipPath>
              </defs>
              <g clipPath={`url(#${id}-s)`}>
                <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
                <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" strokeWidth="6"/>
                <path d="M0,0 L60,30 M60,0 L0,30" clipPath={`url(#${id}-t)`} stroke="#C8102E" strokeWidth="4"/>
                <path d="M30,0 v30 M0,15 h60" stroke="#fff" strokeWidth="10"/>
                <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" strokeWidth="6"/>
              </g>
            </svg>
          );
        };

        const NeuralMesh = ({ combo }) => {
          const intensity = Math.min(combo / 10, 1);
          const pulseDuration = 4 - (intensity * 3);
          const glowOpacity = 0.2 + (intensity * 0.4);

          return (
            <div className="absolute inset-0 overflow-hidden pointer-events-none transition-all duration-1000" style={{ opacity: glowOpacity }}>
              <svg width="100%" height="100%" className="neural-mesh">
                <defs>
                  <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(99, 102, 241, 0.2)" strokeWidth="1"/>
                    <circle cx="0" cy="0" r="1.5" fill="rgba(99, 102, 241, 0.4)" />
                  </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
                <circle 
                  cx="20%" cy="30%" r="150" 
                  className="fill-indigo-500/10 blur-[100px]" 
                  style={{ animation: `pulse ${pulseDuration}s infinite ease-in-out` }} 
                />
                <circle 
                  cx="80%" cy="70%" r="180" 
                  className="fill-purple-500/10 blur-[120px]" 
                  style={{ animation: `pulse ${pulseDuration + 0.5}s infinite ease-in-out` }} 
                />
              </svg>
              <div 
                className="absolute inset-0 transition-opacity duration-1000 bg-indigo-500/5" 
                style={{ opacity: intensity * 0.5 }} 
              />
            </div>
          );
        };

        // --- APP COMPONENT ---
        const App = () => {
          // Hide Loader when App mounts
          useEffect(() => {
            const loader = document.getElementById('initial-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }
          }, []);

          const [language, setLanguage] = useState('en');
          const [level, setLevel] = useState(1);
          const [gameMode, setGameMode] = useState('position');
          const [gameState, setGameState] = useState('idle');
          const [speed, setSpeed] = useState('normal');
          const [isPractice, setIsPractice] = useState(false);
          const [isMarathon, setIsMarathon] = useState(false);
          const [isZenMode, setIsZenMode] = useState(false);
          const [isDailyChallenge, setIsDailyChallenge] = useState(false);
          
          // Challenge State
          const [challengeSeed, setChallengeSeed] = useState(null);
          const [isChallengeCreator, setIsChallengeCreator] = useState(false);
          const [incomingChallenge, setIncomingChallenge] = useState(null);

          // Legal State
          const [legalModal, setLegalModal] = useState(null);

          const [userStats, setUserStats] = useState({
            xp: 0,
            streak: 0,
            lastPlayed: 0,
            rank: RANKS_EN[0].name,
            bestN: 1
          });
          const [combo, setCombo] = useState(0);
          const [maxCombo, setMaxCombo] = useState(0);

          const [history, setHistory] = useState([]);
          const reactionTimes = useRef([]);
          const currentStimulusStartTime = useRef(0);

          const [tutorialStep, setTutorialStep] = useState(null);
          const [tutorialActiveSquare, setTutorialActiveSquare] = useState(null);
          const [tutorialSuccess, setTutorialSuccess] = useState(false);
          const [showIntro, setShowIntro] = useState(false);
          
          const [sequence, setSequence] = useState([]);
          const [currentIndex, setCurrentIndex] = useState(0);
          const [activeStimulus, setActiveStimulus] = useState(null);
          const [isPlaying, setIsPlaying] = useState(false);
          
          const [positionMatches, setPositionMatches] = useState([]);
          const [soundMatches, setSoundMatches] = useState([]);
          const [colorMatches, setColorMatches] = useState([]);
          
          const userPositionInputs = useRef([]);
          const userSoundInputs = useRef([]);
          const userColorInputs = useRef([]);
          
          const [buttonFeedback, setButtonFeedback] = useState({ position: false, sound: false, color: false });
          const [scoreDetails, setScoreDetails] = useState(null);
          const [testSoundIndex, setTestSoundIndex] = useState(0);
          const [demoStep, setDemoStep] = useState(0);
          const [demoActive, setDemoActive] = useState(null);
          const [demoButtonPressed, setDemoButtonPressed] = useState(false);

          const voiceRef = useRef(null);
          const t = TRANSLATIONS[language];
          const currentLetters = language === 'tr' ? LETTERS_TR : LETTERS_EN;

          const triggerHaptic = (type = 'light') => {
            if (typeof navigator !== 'undefined' && navigator.vibrate) {
              const patterns = { 
                light: 15, 
                medium: 30, 
                success: [15, 40, 15], 
                error: [60, 100, 60] 
              };
              navigator.vibrate(patterns[type]);
            }
          };

          const currentRank = useMemo(() => {
            const ranks = language === 'tr' ? RANKS : RANKS_EN;
            const rank = [...ranks].reverse().find(r => userStats.xp >= r.minXp);
            return rank ? rank.name : ranks[0].name;
          }, [userStats.xp, language]);

          // Handle Dynamic Lang Attribute for CSS Uppercase logic
          useEffect(() => {
            document.documentElement.lang = language;
          }, [language]);

          // URL Parser for Incoming Challenges
          useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const cMode = params.get('type'); // 'challenge'
            
            if (cMode === 'challenge') {
              const cSeed = parseInt(params.get('seed') || '0');
              const cLevel = parseInt(params.get('level') || '1');
              const cGameMode = params.get('mode') || 'position';
              const cSpeed = params.get('speed') || 'normal';
              const cTarget = parseInt(params.get('score') || '0');

              if (cSeed) {
                setIncomingChallenge({
                  seed: cSeed,
                  level: cLevel,
                  mode: cGameMode,
                  speed: cSpeed,
                  targetScore: cTarget
                });
                // Pre-set settings
                setLevel(cLevel);
                setGameMode(cGameMode);
                setSpeed(cSpeed);
                // Clear query params to clean URL
                window.history.replaceState({}, '', window.location.pathname);
              }
            }
          }, []);

          useEffect(() => {
            const savedHistory = localStorage.getItem('cognivault_history');
            const savedStats = localStorage.getItem('cognivault_stats');
            const savedLang = localStorage.getItem('cognivault_lang');
            
            if (savedLang && (savedLang === 'tr' || savedLang === 'en')) {
              setLanguage(savedLang);
            }

            if (savedHistory) setHistory(JSON.parse(savedHistory));
            if (savedStats) {
              const stats = JSON.parse(savedStats);
              const today = new Date().setHours(0,0,0,0);
              const yesterday = today - 86400000;
              if (stats.lastPlayed > 0 && stats.lastPlayed < yesterday) {
                stats.streak = 0;
              }
              setUserStats(stats);
            }

            if (!localStorage.getItem('has_seen_intro')) {
              setShowIntro(true);
            }
          }, []);

          useEffect(() => {
            loadVoices(language, (voice) => {
                voiceRef.current = voice;
            });
          }, [language]);

          useEffect(() => {
            localStorage.setItem('cognivault_history', JSON.stringify(history));
          }, [history]);

          useEffect(() => {
            localStorage.setItem('cognivault_stats', JSON.stringify(userStats));
          }, [userStats]);

          const toggleLanguage = () => {
            const newLang = language === 'tr' ? 'en' : 'tr';
            setLanguage(newLang);
            localStorage.setItem('cognivault_lang', newLang);
            triggerHaptic('medium');
          };

          const setSpecificLanguage = (lang) => {
            setLanguage(lang);
            localStorage.setItem('cognivault_lang', lang);
            triggerHaptic('medium');
          };

          const handleKeyDown = useCallback((e) => {
            if (gameState !== 'playing') return;
            const key = e.key.toLowerCase();
            if (key === 'a') handlePositionClick();
            if (key === 'l') handleSoundClick();
            if (key === 's' && gameMode === 'triple') handleColorClick();
          }, [gameState, gameMode]); // Added deps to be safe

          // Need to update the ref/closure for handles
          // However, using Refs for inputs (userPositionInputs) means callbacks are stable-ish
          // But 'currentIndex', 'level' etc are needed inside handlers.
          // Let's rely on standard state access if possible or Refs.
          // Actually, strict closure might be an issue if we don't update listeners.
          // Simpler: Just add dependency.
          useEffect(() => {
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
          }, [handleKeyDown]);

          const calculateScoreForModality = (inputs, matches, limitIndex) => {
            const relevantMatches = matches.filter(m => m < limitIndex);
            const correct = inputs.filter(i => relevantMatches.includes(i)).length;
            const relevantInputs = inputs.filter(i => i < limitIndex);
            const falseAlarms = relevantInputs.filter(i => !relevantMatches.includes(i)).length;
            const missed = relevantMatches.length - correct;
            return { correct, missed, falseAlarms, totalPossible: relevantMatches.length };
          };

          const calculateFinalScore = useCallback(() => {
            const limit = currentIndex;
            const posScore = calculateScoreForModality(userPositionInputs.current, positionMatches, limit);
            const sndScore = calculateScoreForModality(userSoundInputs.current, soundMatches, limit);
            const colScore = calculateScoreForModality(userColorInputs.current, colorMatches, limit);

            const totalCorrect = posScore.correct + (gameMode !== 'position' ? sndScore.correct : 0) + (gameMode === 'triple' ? colScore.correct : 0);
            const totalPossible = posScore.totalPossible + (gameMode !== 'position' ? sndScore.totalPossible : 0) + (gameMode === 'triple' ? colScore.totalPossible : 0);
            const totalMissed = posScore.missed + (gameMode !== 'position' ? sndScore.missed : 0) + (gameMode === 'triple' ? colScore.missed : 0);
            const totalFalseAlarms = posScore.falseAlarms + (gameMode !== 'position' ? sndScore.falseAlarms : 0) + (gameMode === 'triple' ? colScore.falseAlarms : 0);

            const rawPercentage = totalPossible > 0 ? (totalCorrect / totalPossible) * 100 : 0;
            const percentage = Math.max(0, Math.round(rawPercentage));
            
            return {
              position: posScore,
              sound: sndScore,
              color: colScore,
              overall: { percentage, totalCorrect, totalMissed, totalFalseAlarms }
            };
          }, [gameMode, positionMatches, soundMatches, colorMatches, currentIndex]);

          const finishGame = useCallback(() => {
            window.speechSynthesis.cancel();
            const finalDetails = calculateFinalScore();
            const percentage = finalDetails.overall.percentage;
            
            const baseXP = percentage * 2;
            const modeMult = XP_MULTIPLIERS[gameMode] || 1;
            const speedMult = XP_MULTIPLIERS[speed] || 1;
            const levelMult = 1 + (level * 0.2);
            const totalXP = Math.round(baseXP * modeMult * speedMult * levelMult);

            const today = new Date().setHours(0,0,0,0);
            const yesterday = today - 86400000;
            
            let newStreak = userStats.streak;
            if (userStats.lastPlayed === yesterday) {
              newStreak += 1;
            } else if (userStats.lastPlayed < yesterday) {
              newStreak = 1;
            } else if (userStats.lastPlayed === 0) {
              newStreak = 1;
            }

            const record = {
              id: Date.now().toString(),
              date: Date.now(),
              level,
              mode: gameMode,
              score: percentage,
              xpEarned: totalXP,
              details: finalDetails,
              reactionTimes: reactionTimes.current,
              missedPositions: positionMatches.filter(idx => !userPositionInputs.current.includes(idx)).map(idx => sequence[idx].position),
              isDaily: isDailyChallenge
            };

            setHistory(prev => [record, ...prev].slice(0, 100));
            setUserStats(prev => ({
              ...prev,
              xp: prev.xp + totalXP,
              streak: newStreak,
              lastPlayed: today,
              bestN: Math.max(prev.bestN, percentage > 85 ? level : prev.bestN)
            }));

            setScoreDetails(finalDetails);
            setGameState('finished');
            setIsPlaying(false);
            setCombo(0);
            triggerHaptic(percentage > 80 ? 'success' : 'medium');
          }, [calculateFinalScore, level, gameMode, isDailyChallenge, userStats, speed, sequence, positionMatches]);

          const startGame = (isDaily = false, isChallengeCreation = false) => {
            setIsDailyChallenge(isDaily);
            setIsChallengeCreator(isChallengeCreation);
            
            let seed = undefined;

            if (isDaily) {
              seed = new Date().setHours(0,0,0,0);
              setChallengeSeed(null); 
            } else if (isChallengeCreation) {
              const newSeed = Math.floor(Math.random() * 10000000);
              seed = newSeed;
              setChallengeSeed(newSeed);
            } else if (incomingChallenge && !isPractice && !isMarathon) {
               seed = incomingChallenge.seed;
               setChallengeSeed(seed);
            } else {
              setChallengeSeed(null); 
            }

            const len = getSequenceLength(level, isPractice || isMarathon);
            const seq = generateSequence(level, gameMode, len, currentLetters, seed);
            const matches = findMatches(seq, level);
            
            setSequence(seq);
            setPositionMatches(matches.posMatches);
            setSoundMatches(matches.sndMatches);
            setColorMatches(matches.colMatches);
            
            setCurrentIndex(0);
            setScoreDetails(null);
            setCombo(0);
            setMaxCombo(0);
            userPositionInputs.current = [];
            userSoundInputs.current = [];
            userColorInputs.current = [];
            reactionTimes.current = [];
            
            setGameState('playing');
            setIsPlaying(true);
            triggerHaptic('medium');
            
            if (incomingChallenge && !isChallengeCreation) {
                setIncomingChallenge(null);
            }
          };

          const playNextStimulus = useCallback(() => {
            if (isMarathon && currentIndex >= level) {
              const prevIdx = currentIndex - 1;
              const posMatch = positionMatches.includes(prevIdx);
              const sndMatch = gameMode !== 'position' && soundMatches.includes(prevIdx);
              const colMatch = gameMode === 'triple' && colorMatches.includes(prevIdx);
              
              const posMissed = posMatch && !userPositionInputs.current.includes(prevIdx);
              const sndMissed = sndMatch && !userSoundInputs.current.includes(prevIdx);
              const colMissed = colMatch && !userColorInputs.current.includes(prevIdx);

              if (posMissed || sndMissed || colMissed) {
                triggerHaptic('error');
                finishGame();
                return;
              }
            }

            if (currentIndex >= sequence.length) {
              finishGame();
              return;
            }

            const current = sequence[currentIndex];
            const displayColor = (gameMode === 'triple') ? current.color : '#6366f1'; 
            setActiveStimulus({ pos: current.position, col: displayColor });
            currentStimulusStartTime.current = Date.now();
            
            if (gameMode === 'dual' || gameMode === 'triple') {
              speakLetter(current.sound, language, voiceRef.current);
            }

            setTimeout(() => {
              setActiveStimulus(null);
            }, STIMULUS_DURATION);

            setCurrentIndex(prev => prev + 1);
          }, [currentIndex, sequence, gameMode, isMarathon, level, positionMatches, soundMatches, colorMatches, finishGame, language]);

          useEffect(() => {
            if (!isPlaying || gameState !== 'playing') return;
            const timerId = setTimeout(playNextStimulus, SPEED_SETTINGS[speed]);
            return () => clearTimeout(timerId);
          }, [isPlaying, gameState, playNextStimulus, speed]);

          const handlePositionClick = () => {
            if (tutorialStep === 'demo_step_3') {
              setTutorialSuccess(true);
              triggerHaptic('light');
              setButtonFeedback(prev => ({ ...prev, position: true }));
              setTimeout(() => setButtonFeedback(prev => ({ ...prev, position: false })), 200);
              return;
            }

            if (gameState !== 'playing' || currentIndex < level) return;
            const targetIndex = currentIndex - 1;
            const isCorrect = positionMatches.includes(targetIndex);

            if (userPositionInputs.current.includes(targetIndex)) return;
            
            userPositionInputs.current.push(targetIndex);
            triggerHaptic(isCorrect ? 'light' : 'error');
            setButtonFeedback(prev => ({ ...prev, position: true }));
            setTimeout(() => setButtonFeedback(prev => ({ ...prev, position: false })), 200);

            if (isCorrect) {
              recordReactionTime();
              const newCombo = combo + 1;
              setCombo(newCombo);
              setMaxCombo(Math.max(maxCombo, newCombo));
            } else {
              setCombo(0);
              if (isMarathon) finishGame();
            }
          };

          const handleSoundClick = () => {
            if (gameState !== 'playing' || currentIndex < level) return;
            const targetIndex = currentIndex - 1;
            const isCorrect = soundMatches.includes(targetIndex);

            if (userSoundInputs.current.includes(targetIndex)) return;

            userSoundInputs.current.push(targetIndex);
            triggerHaptic(isCorrect ? 'light' : 'error');
            setButtonFeedback(prev => ({ ...prev, sound: true }));
            setTimeout(() => setButtonFeedback(prev => ({ ...prev, sound: false })), 200);

            if (isCorrect) {
              recordReactionTime();
              const newCombo = combo + 1;
              setCombo(newCombo);
              setMaxCombo(Math.max(maxCombo, newCombo));
            } else {
              setCombo(0);
              if (isMarathon) finishGame();
            }
          };

          const handleColorClick = () => {
            if (gameState !== 'playing' || currentIndex < level) return;
            const targetIndex = currentIndex - 1;
            const isCorrect = colorMatches.includes(targetIndex);

            if (userColorInputs.current.includes(targetIndex)) return;

            userColorInputs.current.push(targetIndex);
            triggerHaptic(isCorrect ? 'light' : 'error');
            setButtonFeedback(prev => ({ ...prev, color: true }));
            setTimeout(() => setButtonFeedback(prev => ({ ...prev, color: false })), 200);

            if (isCorrect) {
              recordReactionTime();
              const newCombo = combo + 1;
              setCombo(newCombo);
              setMaxCombo(Math.max(maxCombo, newCombo));
            } else {
              setCombo(0);
              if (isMarathon) finishGame();
            }
          };
          
          const recordReactionTime = () => {
            if (currentStimulusStartTime.current > 0) {
              const now = Date.now();
              const rt = now - currentStimulusStartTime.current;
              reactionTimes.current.push(rt);
            }
          };

          const resetGame = () => {
            window.speechSynthesis.cancel();
            if (scoreDetails && scoreDetails.overall.percentage >= 90 && level < 9 && !isChallengeCreator && !incomingChallenge) {
              setLevel(prev => prev + 1);
            } else if (scoreDetails && scoreDetails.overall.percentage < 60 && level > 1 && !isChallengeCreator && !incomingChallenge) {
              setLevel(prev => prev - 1);
            }
            setGameState('idle');
            triggerHaptic('light');
            setChallengeSeed(null);
            setIsChallengeCreator(false);
          };

          const removeAllProgress = () => {
            if (window.confirm(t.resetConfirm)) {
              localStorage.clear();
              window.location.reload();
            }
          };

          const handleShare = async (title, text, challengeUrl) => {
            const isWeb = window.location.protocol.startsWith('http');
            const shareData = {
              title,
              text,
            };
            
            const urlToShare = challengeUrl || window.location.href;
            if (isWeb) {
              shareData.url = urlToShare;
            }

            if (navigator.share) {
              try {
                await navigator.share(shareData);
              } catch (err) {
                // Ignore AbortError
                if (err.name !== 'AbortError') {
                     try {
                        const clipboardText = `${title}\n${text}${isWeb ? `\n${urlToShare}` : ''}`;
                        await navigator.clipboard.writeText(clipboardText);
                        alert('Panoya kopyaland覺!');
                    } catch (e) {
                        console.error('Clipboard failed', e);
                    }
                }
              }
            } else {
              try {
                const clipboardText = `${title}\n${text}${isWeb ? `\n${urlToShare}` : ''}`;
                await navigator.clipboard.writeText(clipboardText);
                alert('Balant覺 panoya kopyaland覺!');
              } catch (e) {
                console.error('Clipboard failed', e);
              }
            }
          };
          
          const createChallengeLink = () => {
            if (!scoreDetails || !challengeSeed) return;
            
            const baseUrl = window.location.href.split('?')[0];
            const params = new URLSearchParams();
            params.set('type', 'challenge');
            params.set('seed', challengeSeed.toString());
            params.set('level', level.toString());
            params.set('mode', gameMode);
            params.set('speed', speed);
            params.set('score', scoreDetails.overall.percentage.toString());
            
            const fullUrl = `${baseUrl}?${params.toString()}`;
            handleShare(
                t.challenge, 
                t.shareMsg.replace('%{score}', scoreDetails.overall.percentage.toString()).replace('%{level}', level.toString()),
                fullUrl
            );
          };

          const testSound = () => {
            speakLetter(currentLetters[testSoundIndex], language, voiceRef.current);
            setTestSoundIndex((prev) => (prev + 1) % currentLetters.length);
          };

          const startTutorial = () => {
            setTutorialStep('welcome');
            setGameState('idle');
            setTutorialSuccess(false);
            triggerHaptic('medium');
          };

          const nextTutorialStep = () => {
            triggerHaptic('light');
            if (tutorialStep === 'welcome') {
              setTutorialStep('demo_step_1');
              setTutorialActiveSquare(2);
            } else if (tutorialStep === 'demo_step_1') {
              setTutorialStep('demo_step_2');
              setTutorialActiveSquare(6);
            } else if (tutorialStep === 'demo_step_2') {
              setTutorialStep('demo_step_3');
              setTutorialActiveSquare(6);
              setTutorialSuccess(false);
            } else if (tutorialStep === 'demo_step_3') {
              setTutorialStep('ready');
            } else if (tutorialStep === 'ready') {
              setTutorialStep(null);
              setLevel(1);
              setGameMode('position');
              startGame();
            }
          };

          const dismissIntro = () => {
            localStorage.setItem('has_seen_intro', 'true');
            setShowIntro(false);
            triggerHaptic('medium');
          };

          useEffect(() => {
            if (gameState === 'idle') {
              const demoInterval = setInterval(() => setDemoStep(prev => (prev + 1) % 5), 1500);
              return () => clearInterval(demoInterval);
            }
          }, [gameState]);

          useEffect(() => {
            if (gameState === 'idle' && !tutorialStep) {
              const demoPos = level === 1 ? [1, 5, 7, 7, 2] : level === 2 ? [1, 5, 1, 4, 3] : [1, 4, 8, 1, 2];
              setDemoActive(demoPos[demoStep]);
              const isMatch = demoStep >= level && demoPos[demoStep] === demoPos[demoStep - level];
              if (isMatch) {
                const t = setTimeout(() => { setDemoButtonPressed(true); setTimeout(() => setDemoButtonPressed(false), 800); }, 150);
                return () => clearTimeout(t);
              }
              const t2 = setTimeout(() => setDemoActive(null), 700);
              return () => clearTimeout(t2);
            }
          }, [demoStep, gameState, level, tutorialStep]);

          const missedHeatmap = useMemo(() => {
            const map = Array(9).fill(0);
            history.slice(0, 20).forEach(h => {
                if (h.missedPositions) {
                    h.missedPositions.forEach(p => { if(p >= 0 && p < 9) map[p]++ });
                }
            });
            return map;
          }, [history]);
          const maxMiss = Math.max(...missedHeatmap, 1);
          const avgReactionTimeMs = history.length > 0 
          ? Math.round(
              history.reduce((acc, curr) => {
                  const sessionAvg = curr.reactionTimes.length > 0 
                      ? curr.reactionTimes.reduce((a, b) => a + b, 0) / curr.reactionTimes.length 
                      : 0;
                  return acc + sessionAvg;
              }, 0) / history.filter(h => h.reactionTimes.length > 0).length || 0
            )
          : 0;

          const avgReactionTimeSec = (avgReactionTimeMs / 1000).toFixed(2);
          
          const currentTrainingDesc = useMemo(() => {
            if (isPractice) return t.practiceDesc;
            if (isMarathon) return t.marathonDesc;
            return t.standardDesc;
          }, [isPractice, isMarathon, t]);

          // Render (copy of App return)
          return (
            <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 relative overflow-hidden select-none pb-[max(env(safe-area-inset-bottom),16px)] pt-[max(env(safe-area-inset-top),16px)]">
              <NeuralMesh combo={isPlaying ? combo : 0} />
              
              {/* RESTORED TOP HEADER */}
              {gameState === 'idle' && !showIntro && !tutorialStep && (
                  <div className="absolute top-0 left-0 right-0 p-6 flex justify-between items-start z-50 animate-in fade-in slide-in-from-top-4 duration-700">
                      <div className="flex gap-3">
                          <button onClick={startTutorial} className="p-3 bg-slate-800/50 hover:bg-indigo-600 backdrop-blur-md rounded-2xl text-slate-400 hover:text-white transition-all ring-1 ring-white/5 active:scale-95 shadow-lg">
                              <Info size={20} />
                          </button>
                          <button onClick={() => setGameState('analytics')} className="p-3 bg-slate-800/50 hover:bg-emerald-600 backdrop-blur-md rounded-2xl text-slate-400 hover:text-white transition-all ring-1 ring-white/5 active:scale-95 shadow-lg">
                              <BarChart3 size={20} />
                          </button>
                      </div>
                      <div className="flex gap-2 bg-slate-800/50 backdrop-blur-md p-1.5 rounded-2xl ring-1 ring-white/5 shadow-lg">
                          <button onClick={() => setSpecificLanguage('tr')} className={`w-8 h-8 rounded-xl overflow-hidden transition-all ${language === 'tr' ? 'ring-2 ring-indigo-500 scale-110 shadow-lg' : 'opacity-40 hover:opacity-100'}`}>
                              <FlagTR />
                          </button>
                          <button onClick={() => setSpecificLanguage('en')} className={`w-8 h-8 rounded-xl overflow-hidden transition-all ${language === 'en' ? 'ring-2 ring-indigo-500 scale-110 shadow-lg' : 'opacity-40 hover:opacity-100'}`}>
                              <FlagUK />
                          </button>
                      </div>
                  </div>
              )}

              {/* Incoming Challenge Modal */}
              {incomingChallenge && gameState === 'idle' && !tutorialStep && !showIntro && (
                <div className="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6 animate-in fade-in zoom-in duration-300">
                  <div className="bg-slate-900/80 border border-indigo-500/30 p-8 rounded-[3rem] shadow-2xl max-w-md w-full relative">
                    <div className="flex flex-col items-center">
                        <div className="p-5 bg-orange-500/20 rounded-[2rem] mb-6 shadow-inner ring-1 ring-white/10 animate-pulse">
                          <Swords className="text-orange-400" size={48} />
                        </div>
                        <h2 className="text-2xl font-black text-white leading-tight mb-2 text-center">{t.incomingChallenge}</h2>
                        <div className="text-slate-400 text-sm mb-6 text-center">
                          <span dangerouslySetInnerHTML={{ __html: t.friendScore.replace('%{score}', incomingChallenge.targetScore?.toString() || '0') }} />
                          <br/>{t.canYouBeat}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3 w-full mb-6">
                            <div className="bg-slate-950/50 p-3 rounded-xl border border-white/5 text-center">
                                <div className="text-[10px] text-slate-500 font-bold uppercase">{t.level}</div>
                                <div className="text-xl font-black text-white">N-{incomingChallenge.level}</div>
                            </div>
                             <div className="bg-slate-950/50 p-3 rounded-xl border border-white/5 text-center">
                                <div className="text-[10px] text-slate-500 font-bold uppercase">{t.mode}</div>
                                <div className="text-xl font-black text-white capitalize">{t[incomingChallenge.mode]}</div>
                            </div>
                        </div>

                        <button 
                          onClick={() => startGame(false, false)}
                          className="w-full py-5 rounded-[2rem] bg-orange-600 hover:bg-orange-500 text-white font-black text-lg flex items-center justify-center gap-3 transition-all active:scale-95 shadow-lg"
                        >
                          {t.acceptChallenge}
                        </button>
                        <button 
                          onClick={() => setIncomingChallenge(null)}
                          className="mt-4 text-slate-500 text-xs font-bold hover:text-white"
                        >
                          {t.decline}
                        </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Legal Modal */}
              {legalModal && (
                  <div className="fixed inset-0 z-[150] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6 animate-in fade-in zoom-in duration-300">
                    <div className="bg-slate-900 border border-white/10 p-8 rounded-[2rem] shadow-2xl max-w-md w-full relative flex flex-col max-h-[90vh]">
                      <button onClick={() => setLegalModal(null)} className="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors">
                        <XCircle size={24} />
                      </button>
                      <h2 className="text-2xl font-black text-white mb-6 shrink-0">
                        {legalModal === 'terms' ? t.terms : t.privacy}
                      </h2>
                      <div className="text-slate-400 text-sm leading-relaxed space-y-4 overflow-y-auto pr-2 custom-scrollbar">
                        <p>{legalModal === 'terms' ? t.termsContent : t.privacyContent}</p>
                      </div>
                      <button 
                        onClick={() => setLegalModal(null)}
                        className="w-full mt-6 py-4 rounded-xl bg-slate-800 text-white font-bold text-sm hover:bg-slate-700 transition-colors shrink-0"
                      >
                        {t.close}
                      </button>
                    </div>
                  </div>
                )}
              
              {/* Analytics View */}
              {gameState === 'analytics' && (
                  <div className="fixed inset-0 z-[120] bg-slate-950/90 backdrop-blur-xl flex flex-col items-center p-6 animate-in fade-in zoom-in duration-300 overflow-y-auto">
                     <div className="w-full max-w-lg space-y-6 pb-12">
                         <div className="flex justify-between items-center">
                            <h2 className="text-3xl font-black text-white">{t.analytics}</h2>
                            <button onClick={() => setGameState('idle')} className="p-3 bg-slate-800 rounded-full hover:bg-slate-700 transition-colors">
                                <XCircle size={24} className="text-white" />
                            </button>
                         </div>
                         
                         {/* High Level Stats */}
                         <div className="grid grid-cols-2 gap-4">
                             <div className="bg-slate-900/50 p-5 rounded-3xl border border-white/5 flex flex-col items-center text-center">
                                 <div className="text-xs text-slate-500 font-bold uppercase tracking-widest mb-1">{t.bestN}</div>
                                 <div className="text-4xl font-black text-indigo-400">N-{userStats.bestN}</div>
                             </div>
                             <div className="bg-slate-900/50 p-5 rounded-3xl border border-white/5 flex flex-col items-center text-center">
                                 <div className="text-xs text-slate-500 font-bold uppercase tracking-widest mb-1">{t.score}</div>
                                 <div className="text-4xl font-black text-yellow-400">{userStats.xp}</div>
                             </div>
                         </div>
                         
                         {/* Reaction Time */}
                         <div className="bg-slate-900/50 p-6 rounded-3xl border border-white/5">
                             <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2"><Zap size={16} className="text-orange-400"/> {t.reactionTime}</h3>
                             <div className="text-center py-4">
                                 <div className="text-5xl font-black text-white">{avgReactionTimeSec}<span className="text-lg text-slate-500 ml-1">s</span></div>
                                 <div className="text-xs text-slate-500 mt-2">Average response speed</div>
                             </div>
                         </div>

                         {/* Heatmap */}
                         <div className="bg-slate-900/50 p-6 rounded-3xl border border-white/5">
                             <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2"><Target size={16} className="text-rose-400"/> {t.attentionMap}</h3>
                             <div className="grid grid-cols-3 gap-2 aspect-square max-w-[200px] mx-auto">
                                {missedHeatmap.map((count, i) => (
                                    <div key={i} className="rounded-lg aspect-square flex items-center justify-center text-xs font-bold transition-all" 
                                         style={{ backgroundColor: `rgba(244, 63, 94, ${count / maxMiss})`, color: count > maxMiss/2 ? 'white' : 'rgba(255,255,255,0.3)', border: '1px solid rgba(255,255,255,0.05)' }}>
                                        {count > 0 ? count : ''}
                                    </div>
                                ))}
                             </div>
                         </div>
                         
                         {/* Data Reset */}
                         <div className="pt-8">
                             <button onClick={removeAllProgress} className="w-full py-4 rounded-2xl bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 font-bold text-sm border border-rose-500/20 flex items-center justify-center gap-2 transition-all">
                                <Trash2 size={16} /> {t.resetData}
                             </button>
                         </div>
                     </div>
                  </div>
              )}

              {showIntro && (
                <div className="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6 animate-in fade-in zoom-in duration-300">
                    <div className="bg-slate-900/80 border border-indigo-500/30 p-8 rounded-[3rem] shadow-2xl max-w-md w-full relative">
                      <div className="flex flex-col items-center relative">
                         <div className="absolute top-0 right-0 flex gap-2">
                            <button onClick={() => setSpecificLanguage('tr')} className={`w-8 h-8 rounded-full overflow-hidden transition-all ring-2 ${language === 'tr' ? 'ring-indigo-500 scale-110' : 'ring-white/10 opacity-50 hover:opacity-100'}`}>
                                <FlagTR />
                            </button>
                            <button onClick={() => setSpecificLanguage('en')} className={`w-8 h-8 rounded-full overflow-hidden transition-all ring-2 ${language === 'en' ? 'ring-indigo-500 scale-110' : 'ring-white/10 opacity-50 hover:opacity-100'}`}>
                                <FlagUK />
                            </button>
                         </div>

                         <div className="p-5 bg-indigo-500/20 rounded-[2rem] mb-6 shadow-inner ring-1 ring-white/10 mt-8">
                            <Brain className="text-indigo-400" size={48} />
                         </div>
                         <h2 className="text-3xl font-black text-white leading-tight mb-6 text-center">{t.howToPlay}</h2>
                         <div className="text-slate-400 text-sm leading-relaxed space-y-4 text-center mb-8">
                            <p>{t.intro1}</p>
                            <p>{t.intro2}</p>
                            <p>{t.intro3}</p>
                         </div>
                         <button 
                           onClick={dismissIntro}
                           className="w-full py-5 rounded-[2rem] bg-indigo-600 hover:bg-indigo-500 text-white font-black text-lg flex items-center justify-center gap-3 transition-all active:scale-95 shadow-lg"
                         >
                           {t.gotIt} <ChevronRight size={22} />
                         </button>
                      </div>
                    </div>
                </div>
              )}

              {tutorialStep && (
                <div className="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6 animate-in fade-in zoom-in duration-300">
                  <div className="bg-slate-900/80 border border-indigo-500/30 p-8 rounded-[3rem] shadow-2xl max-w-md w-full relative">
                    <button onClick={() => setTutorialStep(null)} className="absolute top-8 right-8 text-slate-500 hover:text-white transition-colors">
                      <XCircle size={24} />
                    </button>
                    <div className="flex flex-col items-center">
                       <div className="p-5 bg-indigo-500/20 rounded-[2rem] mb-6 shadow-inner ring-1 ring-white/10">
                          <HelpCircle className="text-indigo-400" size={48} />
                       </div>
                       <div className="space-y-4 text-center mb-8">
                        <h2 className="text-3xl font-black text-white leading-tight">
                          {tutorialStep === 'welcome' ? t.tutorialWelcome : tutorialStep === 'ready' ? t.tutorialReady : t.brainTraining}
                        </h2>
                        <div className="text-slate-400 text-sm leading-relaxed px-2">
                          {tutorialStep === 'welcome' && t.tutorialWelcomeText}
                          {tutorialStep === 'demo_step_1' && t.tutorialStep1}
                          {tutorialStep === 'demo_step_2' && t.tutorialStep2}
                          {tutorialStep === 'demo_step_3' && (
                             <div className="flex flex-col gap-2">
                                <p>{t.tutorialStep3Match}</p>
                             </div>
                          )}
                          {tutorialStep === 'ready' && t.tutorialReadyText}
                        </div>
                        {['demo_step_1', 'demo_step_2', 'demo_step_3'].includes(tutorialStep) && (
                          <div className="grid grid-cols-3 gap-2 aspect-square w-32 mx-auto p-3 bg-slate-950/80 rounded-3xl border border-white/5 shadow-2xl mt-4">
                            {[...Array(9)].map((_, i) => (
                              <div key={i} className={`rounded-xl transition-all duration-300 aspect-square ${tutorialActiveSquare === i ? 'bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.6)]' : 'bg-slate-800'}`} />
                            ))}
                          </div>
                        )}
                        {tutorialStep === 'demo_step_3' && !tutorialSuccess && (
                             <div className="mt-6 flex justify-center w-full">
                                <button onClick={() => handlePositionClick()} className="px-8 py-3 bg-indigo-600 text-white rounded-2xl font-black text-sm animate-bounce shadow-lg w-full max-w-[200px]">{t.tutorialBtn}</button>
                             </div>
                        )}
                      </div>
                      <button 
                        onClick={nextTutorialStep}
                        disabled={tutorialStep === 'demo_step_3' && !tutorialSuccess}
                        className="w-full py-5 rounded-[2rem] bg-indigo-600 hover:bg-indigo-500 text-white font-black text-lg flex items-center justify-center gap-3 transition-all active:scale-95 shadow-[0_10px_30px_rgba(79,70,229,0.3)] disabled:opacity-50"
                      >
                        {tutorialStep === 'ready' ? t.start : t.continue}
                        <ChevronRight size={22} />
                      </button>
                    </div>
                  </div>
                </div>
              )}

              <div className={`max-w-xl w-full relative z-10 transition-all duration-700 flex flex-col ${isZenMode && isPlaying ? 'gap-0 min-h-[85vh] justify-center items-center' : 'gap-4 pt-16'}`}>
                
                {/* IDLE TITLE - Restored Header */}
                {gameState === 'idle' && (
                  <div className="text-center mb-4 animate-in fade-in slide-in-from-top-4 duration-500">
                    <h1 className="text-4xl md:text-6xl font-black text-white tracking-tighter mb-2">
                      {t.title}
                    </h1>
                    <p className="text-indigo-400 font-bold uppercase tracking-[0.3em] text-[10px] md:text-xs">
                      {t.subtitle}
                    </p>
                  </div>
                )}

                {/* STATS BAR - Hide in Zen Mode Playing */}
                {(!isZenMode || !isPlaying) && gameState !== 'finished' && gameState !== 'analytics' && (
                  <div className="flex items-center justify-between px-2 mb-2 animate-in slide-in-from-top-4 duration-500 w-full">
                     <div className="flex items-center gap-3 bg-slate-900/40 backdrop-blur-xl border border-white/5 py-2 px-4 rounded-2xl">
                        <Flame className={`text-orange-500 ${userStats.streak > 0 ? 'fill-orange-500 animate-pulse' : ''}`} size={20} />
                        <span className="text-white font-black text-sm md:text-base">{userStats.streak} {t.streak}</span>
                     </div>
                     <div className="flex items-center gap-3 bg-slate-900/40 backdrop-blur-xl border border-white/5 py-2 px-4 rounded-2xl">
                        <Star className="text-yellow-400 fill-yellow-400" size={18} />
                        <span className="text-white font-black text-sm md:text-base">{userStats.xp} {t.score}  {currentRank}</span>
                     </div>
                  </div>
                )}

                {/* FINISHED SCREEN */}
                {gameState === 'finished' && scoreDetails && (
                    <div className="w-full max-w-md animate-in fade-in zoom-in duration-300 m-auto">
                        <div className="bg-slate-900/40 backdrop-blur-xl border border-white/10 p-8 rounded-[3rem] shadow-2xl flex flex-col items-center text-center">
                            <div className="p-4 bg-indigo-500/20 rounded-full mb-6 ring-1 ring-white/10 shadow-[0_0_30px_rgba(99,102,241,0.2)]">
                                <Trophy className="text-indigo-400" size={40} />
                            </div>
                            <h2 className="text-3xl font-black text-white mb-2">{t.sessionComplete}</h2>
                            <div className="flex items-center gap-2 mb-8">
                                <span className="px-3 py-1 rounded-lg bg-slate-800/50 border border-white/5 text-xs font-bold text-slate-400 uppercase tracking-widest">{t.level} {level}</span>
                                <span className="px-3 py-1 rounded-lg bg-slate-800/50 border border-white/5 text-xs font-bold text-slate-400 uppercase tracking-widest">{t[gameMode]}</span>
                            </div>
                            
                            {/* Big Score */}
                            <div className="relative mb-8">
                                    <div className="text-6xl font-black text-white tracking-tighter">{scoreDetails.overall.percentage}%</div>
                                    <div className="text-xs font-bold text-indigo-400 uppercase tracking-[0.2em] mt-1">{t.score}</div>
                            </div>

                            {/* Stats */}
                            <div className="grid grid-cols-2 gap-3 w-full mb-8">
                                    <div className="p-4 rounded-2xl bg-emerald-500/10 border border-emerald-500/20 flex flex-col items-center">
                                    <span className="text-2xl font-black text-emerald-400">{scoreDetails.overall.totalCorrect}</span>
                                    <span className="text-[10px] font-black text-emerald-500/70 uppercase tracking-widest">{t.correct}</span>
                                    </div>
                                    <div className="p-4 rounded-2xl bg-rose-500/10 border border-rose-500/20 flex flex-col items-center">
                                    <span className="text-2xl font-black text-rose-400">{scoreDetails.overall.totalMissed + scoreDetails.overall.totalFalseAlarms}</span>
                                    <span className="text-[10px] font-black text-rose-500/70 uppercase tracking-widest">{t.mistakes}</span>
                                    </div>
                            </div>

                            {/* Actions */}
                            <div className="flex flex-col w-full gap-3">
                                <button onClick={() => startGame(isDailyChallenge, false)} className="w-full py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-500 text-white font-black text-sm flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95">
                                    <RotateCcw size={18} /> {t.playAgain}
                                </button>
                                <button onClick={() => setGameState('idle')} className="w-full py-4 rounded-2xl bg-slate-800/50 hover:bg-slate-800 text-slate-400 hover:text-white font-black text-sm flex items-center justify-center gap-2 border border-white/5 transition-all active:scale-95">
                                    <ArrowLeft size={18} /> {t.menu}
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* GAME CONTAINER - Restructured for Zen Mode */}
                {gameState !== 'finished' && gameState !== 'analytics' && (
                  <div className={`transition-all duration-700 w-full flex flex-col items-center ${isZenMode && isPlaying ? 'bg-transparent' : 'bg-slate-900/30 backdrop-blur-3xl border border-white/10 rounded-[2rem] sm:rounded-[3rem] p-5 sm:p-8 shadow-2xl'}`}>
                    
                    {/* GRID - Visible in Idle AND Playing (regardless of Zen Mode) */}
                    {(gameState === 'idle' || gameState === 'playing') && (
                      <div className={`relative flex justify-center transition-all duration-700 ${isZenMode && isPlaying ? 'flex-1 items-center mb-0' : 'mb-8'} w-full`}>
                         <div className={`grid grid-cols-3 gap-4 aspect-square w-full transition-all duration-500 ${isZenMode && isPlaying ? 'w-full max-w-[min(90vw,60vh)] p-8 bg-transparent' : 'max-w-[420px] md:max-w-[500px] p-5 bg-slate-950/40 rounded-[3rem] border-2 border-white/5 shadow-2xl'} ${isPlaying && !isZenMode ? 'border-indigo-500/30 ring-8 ring-indigo-500/5 shadow-[0_0_30px_rgba(99,102,241,0.1)]' : ''}`}>
                            {[...Array(9)].map((_, i) => {
                              const isActive = gameState === 'idle' ? i === demoActive : activeStimulus?.pos === i;
                              const activeColor = activeStimulus?.col || '#6366f1';
                              return (
                                <div key={i} style={{ backgroundColor: isActive ? activeColor : undefined }} className={`rounded-2xl transition-all duration-150 border transform aspect-square ${isActive ? 'scale-105 shadow-[0_0_20px_rgba(255,255,255,0.2)] ring-4 ring-white/10' : 'bg-slate-900/40 border-white/5'}`} />
                              );
                            })}
                         </div>
                      </div>
                    )}

                    {/* STANDARD CONTROLS - Hide in Zen Mode Playing */}
                    <div className={`transition-all duration-500 w-full ${isZenMode && isPlaying ? 'hidden' : 'max-w-[420px] flex flex-col items-center px-4'}`}>
                      {gameState === 'idle' && (
                        <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500 w-full">
                          <button onClick={() => startGame(false)} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-6 rounded-[2rem] font-black text-2xl md:text-3xl flex items-center justify-center gap-4 transition-all shadow-xl shadow-indigo-600/30 active:scale-95 group">
                            <Play size={28} className="fill-white group-hover:scale-110 transition-transform" />
                            {t.startGame}
                          </button>
                          <div className="flex gap-4">
                              <button onClick={() => startGame(true)} className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-5 rounded-[1.5rem] font-black text-xs md:text-sm flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                <Calendar size={18} /> {t.dailyRace}
                              </button>
                              <button onClick={() => startGame(false, true)} className="flex-1 bg-orange-600 hover:bg-orange-500 text-white py-5 rounded-[1.5rem] font-black text-xs md:text-sm flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                <Swords size={18} /> {t.challenge}
                              </button>
                          </div>
                        </div>
                      )}

                       {/* SETTINGS PARAMETERS - Clean Buttons */}
                      {gameState === 'idle' && (
                        <div className="space-y-6 mt-8 animate-in fade-in duration-500 w-full border-t border-white/5 pt-6">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 items-stretch">
                                <div className="flex flex-col space-y-2 h-full">
                                    <label className="text-[11px] md:text-xs font-black text-slate-500 uppercase tracking-widest px-1 flex items-center gap-2">
                                    <Target size={14} className="text-indigo-500" /> {t.difficulty}
                                    </label>
                                    <div className="flex flex-1 p-1.5 bg-slate-800/40 rounded-2xl border border-white/5">
                                    {[1, 2, 3, 4, 5].map((l) => (
                                        <button key={l} onClick={() => { setLevel(l); triggerHaptic('light'); }} className={`flex-1 py-2 rounded-xl font-black text-sm md:text-base transition-all active:scale-90 ${level === l ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-400 hover:text-white'}`}>{l}</button>
                                    ))}
                                    </div>
                                </div>
                                <div className="flex flex-col space-y-2 h-full">
                                    <label className="text-[11px] md:text-xs font-black text-slate-500 uppercase tracking-widest px-1 flex items-center gap-2">
                                    <Palette size={14} className="text-purple-500" /> {t.gameMode}
                                    </label>
                                    <div className="flex flex-1 p-1.5 bg-slate-800/40 rounded-2xl border border-white/5">
                                    {['position', 'dual', 'triple'].map((m) => (
                                        <button key={m} onClick={() => { setGameMode(m); triggerHaptic('light'); }} className={`flex-1 min-w-0 py-2 rounded-xl font-black text-[10px] md:text-xs transition-all active:scale-90 ${gameMode === m ? 'bg-indigo-500 text-white shadow-lg' : 'text-slate-400'}`}>
                                        {t[m]}
                                        </button>
                                    ))}
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 items-stretch">
                                <div className="flex flex-col space-y-2 h-full">
                                    <label className="text-[11px] md:text-xs font-black text-slate-500 uppercase tracking-widest px-1 flex items-center gap-2">
                                    <Gauge size={14} className="text-yellow-500" /> {t.speed}
                                    </label>
                                    <div className="flex flex-1 p-1.5 bg-slate-800/40 rounded-2xl border border-white/5">
                                    {['slow', 'normal', 'fast'].map((s) => (
                                        <button key={s} onClick={() => { setSpeed(s); triggerHaptic('light'); }} className={`flex-1 py-2 rounded-xl font-black text-[10px] md:text-xs transition-all active:scale-90 ${speed === s ? 'bg-indigo-500 text-white shadow-lg' : 'text-slate-400'}`}>
                                        {t[s]}
                                        </button>
                                    ))}
                                    </div>
                                </div>
                                <div className="flex flex-col space-y-2 h-full">
                                    <label className="text-[11px] md:text-xs font-black text-slate-500 uppercase tracking-widest px-1 flex items-center gap-2">
                                    <TrendingUp size={14} className="text-emerald-500" /> {t.trainingMode}
                                    </label>
                                    <div className="flex flex-1 p-1.5 bg-slate-800/40 rounded-2xl border border-white/5 gap-1">
                                    <button onClick={() => { setIsPractice(false); setIsMarathon(false); triggerHaptic('light'); }} className={`flex-1 py-2 rounded-xl font-black text-[10px] md:text-xs transition-all active:scale-90 ${!isPractice && !isMarathon ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'text-slate-400'}`}>{t.standard}</button>
                                    <button onClick={() => { setIsPractice(true); setIsMarathon(false); triggerHaptic('light'); }} className={`flex-1 py-2 rounded-xl font-black text-[10px] md:text-xs transition-all active:scale-90 ${isPractice ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'text-slate-400'}`}>{t.practice}</button>
                                    <button onClick={() => { setIsMarathon(true); setIsPractice(false); triggerHaptic('light'); }} className={`flex-1 py-2 rounded-xl font-black text-[10px] md:text-xs transition-all active:scale-90 ${isMarathon ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/20' : 'text-slate-400'}`}>{t.marathon}</button>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4">
                            <button onClick={() => setIsZenMode(!isZenMode)} className={`flex-1 py-4 rounded-2xl font-black text-xs md:text-sm flex items-center justify-center gap-2 transition-all active:scale-95 border ${isZenMode ? 'bg-indigo-500/20 border-indigo-500/40 text-indigo-200' : 'bg-slate-800/30 border-white/5 text-slate-400'}`}>
                                <EyeOff size={16} /> {t.zenMode}
                            </button>
                            <button onClick={testSound} className="flex-1 py-4 rounded-2xl font-black text-xs md:text-sm flex items-center justify-center gap-2 transition-all active:scale-95 border bg-slate-800/30 border-white/5 text-slate-400">
                                <Volume2 size={16} /> {t.soundCheck}
                            </button>
                            </div>
                        </div>
                        )}

                        {/* GAME PARAMETERS INFO GRID (NEW) */}
                        {gameState === 'idle' && (
                          <div className="mt-12 w-full max-w-2xl bg-slate-900/40 rounded-[2.5rem] p-8 border border-white/5 animate-in fade-in duration-700">
                              <h3 className="flex items-center gap-3 text-sm md:text-base font-black text-slate-300 uppercase tracking-widest mb-8">
                                  <Info size={18} className="text-indigo-500" /> {t.gameParamsTitle}
                              </h3>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-8">
                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <Palette size={18} className="text-indigo-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.gameMode}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.gameModeDesc}</p>
                                      </div>
                                  </div>

                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <TrendingUp size={18} className="text-emerald-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.practice}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.practiceDesc}</p>
                                      </div>
                                  </div>

                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <Target size={18} className="text-blue-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.difficulty}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.difficultyDesc}</p>
                                      </div>
                                  </div>

                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <Zap size={18} className="text-rose-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.marathon}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.marathonDesc}</p>
                                      </div>
                                  </div>

                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <Calendar size={18} className="text-emerald-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.dailyRace}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.dailyRaceDesc}</p>
                                      </div>
                                  </div>

                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <EyeOff size={18} className="text-slate-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.zenMode}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.zenModeDesc}</p>
                                      </div>
                                  </div>

                                  <div className="flex gap-4 items-start">
                                      <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-white/5">
                                          <Swords size={18} className="text-orange-400" />
                                      </div>
                                      <div>
                                          <h4 className="font-black text-sm text-white mb-1 uppercase">{t.challenge}</h4>
                                          <p className="text-xs text-slate-400 leading-relaxed">{t.challengeDesc}</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                        )}

                      {gameState === 'playing' && (
                        <div className="space-y-6 w-full">
                          <div className={`grid ${gameMode === 'position' ? 'grid-cols-1' : gameMode === 'dual' ? 'grid-cols-2' : 'grid-cols-3'} gap-4 w-full`}>
                            <button 
                              onMouseDown={handlePositionClick} 
                              disabled={currentIndex <= level} 
                              className={`relative rounded-[2rem] font-black transition-all border-2 active:scale-90 shadow-2xl ${buttonFeedback.position ? 'bg-indigo-400 border-white/40' : 'bg-indigo-600 border-transparent'} text-white disabled:opacity-30 py-8`}
                            >
                              <div className="flex flex-col items-center gap-2">
                                <Square size={36} />
                                <span className={`text-[11px] md:text-sm uppercase tracking-[0.2em] font-black`}>
                                    {t.position}
                                    <span className="hidden lg:inline-block ml-1 opacity-40 font-mono text-[9px] md:text-[11px]">(A)</span>
                                </span>
                              </div>
                            </button>
                            {(gameMode === 'dual' || gameMode === 'triple') && (
                              <button 
                                onMouseDown={handleSoundClick} 
                                disabled={currentIndex <= level} 
                                className={`relative rounded-[2rem] font-black transition-all border-2 active:scale-90 shadow-2xl ${buttonFeedback.sound ? 'bg-purple-400 border-white/40' : 'bg-purple-600 border-transparent'} text-white disabled:opacity-30 py-8`}
                              >
                                <div className="flex flex-col items-center gap-2">
                                  <Volume2 size={36} />
                                  <span className={`text-[11px] md:text-sm uppercase tracking-[0.2em] font-black`}>
                                    {t.sound}
                                    <span className="hidden lg:inline-block ml-1 opacity-40 font-mono text-[9px] md:text-[11px]">(L)</span>
                                  </span>
                                </div>
                              </button>
                            )}
                            {gameMode === 'triple' && (
                              <button 
                                onMouseDown={handleColorClick} 
                                disabled={currentIndex <= level} 
                                className={`relative rounded-[2rem] font-black transition-all border-2 active:scale-90 shadow-2xl ${buttonFeedback.color ? 'bg-emerald-400 border-white/40' : 'bg-emerald-600 border-transparent'} text-white disabled:opacity-30 py-8`}
                              >
                                <div className="flex flex-col items-center gap-2">
                                  <Palette size={36} />
                                  <span className={`text-[11px] md:text-sm uppercase tracking-[0.2em] font-black`}>
                                    {t.color}
                                    <span className="hidden lg:inline-block ml-1 opacity-40 font-mono text-[9px] md:text-[11px]">(S)</span>
                                  </span>
                                </div>
                              </button>
                            )}
                          </div>
                          <div className="bg-slate-950/40 p-4 rounded-[1.5rem] border border-white/5 shadow-inner">
                              <div className="flex justify-between items-center mb-2 px-1">
                                <span className="text-slate-500 text-[10px] md:text-xs font-black uppercase tracking-widest">{t.progress}</span>
                                <span className="text-white text-[10px] md:text-xs font-black bg-indigo-500/20 px-2 py-0.5 rounded-lg border border-indigo-500/20">{currentIndex} / {sequence.length}</span>
                              </div>
                              <div className="w-full bg-slate-900 rounded-full h-2 overflow-hidden ring-1 ring-white/5">
                                <div className="bg-indigo-500 h-full transition-all duration-300 shadow-[0_0_10px_rgba(99,102,241,0.4)]" style={{ width: `${(currentIndex / (sequence.length || 1)) * 100}%` }} />
                              </div>
                            </div>
                          <button onClick={() => { triggerHaptic('medium'); finishGame(); }} className="w-full py-4 rounded-[1.5rem] bg-slate-800/40 text-slate-500 font-black text-xs md:text-sm flex items-center justify-center gap-2 border border-white/5 hover:bg-slate-800 hover:text-rose-400 transition-all active:scale-95">
                            <ZapOff size={16} /> {t.endGame}
                          </button>
                        </div>
                      )}
                    </div>
                    
                    {/* ZEN MODE FIXED CONTROLS */}
                    {isZenMode && isPlaying && (
                         <div className="fixed bottom-0 left-0 right-0 p-8 flex justify-center gap-6 pb-12 z-50">
                            <button 
                              onMouseDown={handlePositionClick} 
                              className={`flex-1 max-w-[140px] aspect-square rounded-[2.5rem] flex flex-col items-center justify-center gap-3 transition-all active:scale-95 border-4 ${buttonFeedback.position ? 'bg-indigo-500 border-white/20' : 'bg-slate-900/50 border-white/10 backdrop-blur-md'}`}
                            >
                                <Square size={32} className="text-white" />
                            </button>
                            {(gameMode === 'dual' || gameMode === 'triple') && (
                               <button 
                                onMouseDown={handleSoundClick} 
                                className={`flex-1 max-w-[140px] aspect-square rounded-[2.5rem] flex flex-col items-center justify-center gap-3 transition-all active:scale-95 border-4 ${buttonFeedback.sound ? 'bg-purple-500 border-white/20' : 'bg-slate-900/50 border-white/10 backdrop-blur-md'}`}
                              >
                                  <Volume2 size={32} className="text-white" />
                              </button>
                            )}
                             {gameMode === 'triple' && (
                               <button 
                                onMouseDown={handleColorClick} 
                                className={`flex-1 max-w-[140px] aspect-square rounded-[2.5rem] flex flex-col items-center justify-center gap-3 transition-all active:scale-95 border-4 ${buttonFeedback.color ? 'bg-emerald-500 border-white/20' : 'bg-slate-900/50 border-white/10 backdrop-blur-md'}`}
                              >
                                  <Palette size={32} className="text-white" />
                              </button>
                            )}
                         </div>
                    )}
                    {/* Quit button for Zen mode */}
                     {isZenMode && isPlaying && (
                        <button onClick={() => { triggerHaptic('medium'); finishGame(); }} className="fixed top-8 right-8 p-4 rounded-full bg-slate-900/20 text-white/20 hover:text-white hover:bg-rose-500/20 transition-all z-50">
                            <ZapOff size={20} />
                        </button>
                     )}
                  </div>
                )}

                 {/* FOOTER */}
                 {gameState === 'idle' && (
                  <div className="mt-8 text-center space-y-2 animate-in fade-in duration-700 delay-300">
                    <div className="flex items-center justify-center gap-4 text-[10px] md:text-xs text-slate-500 font-medium">
                      <button onClick={() => setLegalModal('terms')} className="hover:text-slate-300 transition-colors underline decoration-slate-700 underline-offset-4">{t.terms}</button>
                      <span className="w-1 h-1 rounded-full bg-slate-700"></span>
                      <button onClick={() => setLegalModal('privacy')} className="hover:text-slate-300 transition-colors underline decoration-slate-700 underline-offset-4">{t.privacy}</button>
                    </div>
                    <p className="text-[10px] text-slate-600">
                      &copy; {new Date().getFullYear()} {t.title}. {t.rights}  {t.vibedWith}
                    </p>
                  </div>
                )}
              </div>
              <Analytics />
            </div>
          );
        };

        // --- RENDER ---
        const container = document.getElementById('root');
        if (container) {
          const root = createRoot(container);
          root.render(<App />);
        }

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>
</html>